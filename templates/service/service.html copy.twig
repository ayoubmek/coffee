 {% extends 'base.html.twig' %}

{% block title %}Hello TeamController!{% endblock %}

{% block body %}
	<body id="kt_body" class="header-fixed header-tablet-and-mobile-fixed toolbar-enabled"> 
		<script>var defaultThemeMode = "light"; var themeMode; if ( document.documentElement ) { if ( document.documentElement.hasAttribute("data-bs-theme-mode")) { themeMode = document.documentElement.getAttribute("data-bs-theme-mode"); } else { if ( localStorage.getItem("data-bs-theme") !== null ) { themeMode = localStorage.getItem("data-bs-theme"); } else { themeMode = defaultThemeMode; } } if (themeMode === "system") { themeMode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; } document.documentElement.setAttribute("data-bs-theme", themeMode); }</script>
		<div class="d-flex flex-column flex-root">
			<div class="page d-flex flex-row flex-column-fluid">
				<div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
				<div class="toolbar py-5 pb-lg-15" id="kt_toolbar">
					<div id="kt_toolbar_container" class="container-xxl d-flex flex-stack flex-wrap">
						<div class="page-title d-flex flex-column me-3">
							<h1 class="d-flex text-white fw-bold my-1 fs-3">Make order</h1>
						</div>
					 
					</div>
				</div> 
				<div id="kt_content_container" class="d-flex flex-column-fluid align-items-start container-xxl">
					<div class="content flex-row-fluid" id="kt_content">
						<div class="d-flex flex-column flex-xl-row"> 
							<div class="d-flex flex-row-fluid me-xl-9 mb-10 mb-xl-0">
								<div class="card card-flush card-p-0 bg-transparent border-0">
									<div class="card-body"> 
										<ul class="nav nav-pills d-flex justify-content-between nav-pills-custom gap-3 mb-6">
											{% for category in categories %}
												{% set isActive = loop.first ? 'show active' : '' %}
												<li class="nav-item mb-3 me-0">
													<a class="nav-link nav-link-border-solid btn btn-outline btn-flex btn-active-color-primary flex-column flex-stack pt-9 pb-7 page-bg {{ isActive }}"
													data-bs-toggle="pill"
													href="#kt_pos_food_content_{{ loop.index }}"   
													style="width: 138px;height: 180px">
														<div class="nav-icon mb-3">
															{% set icon = ['spaghetti.svg','salad.svg','cheeseburger.svg','coffee.svg','cheesecake.svg'] %}
															<img src="{{ asset('/assets/media/svg/food-icons/' ~ category.image) }}"
																class="w-50px" alt="{{ category.name }}">
														</div>
														<div>
															<span class="text-gray-800 fw-bold fs-2 d-block">{{ category.name }}</span>
															<span class="text-gray-400 fw-semibold fs-7">{{ category.services|length }} services</span>
														</div>
													</a>
												</li>
											{% endfor %}
										</ul>
				
										<div class="tab-content">
											{% for category in categories %}
												{% set isActive = loop.first ? 'show active' : '' %}
												<div class="tab-pane fade {{ isActive }}" id="kt_pos_food_content_{{ loop.index }}">
													<div class="d-flex flex-wrap d-grid gap-5 gap-xxl-9">
														{% for service in category.services %}
															<div class="card card-flush flex-row-fluid p-6 pb-5 mw-100"
																style="cursor: pointer"
																data-service-id="{{ service.id }}"
																data-service-name="{{ service.name }}"
																data-service-price="{{ service.price }}"
																data-service-duration="{{ service.duration }}"
																onclick="addServiceCardToCart(this)">

																<div class="card-body text-center">
																	<img src="{{ asset('assets/media/stock/food/' ~ service.image) }}"
																		class="rounded-3 mb-4 w-150px h-150px w-xxl-200px h-xxl-200px"
																		alt="{{ service.name }}">

																	<div class="mb-2">
																		<div class="text-center">
																			<span class="fw-bold text-gray-800 fs-3 fs-xl-1">
																				{{ service.name }}
																			</span>
																			<span class="text-gray-400 fw-semibold d-block fs-6 mt-n1">
																				{{ service.duration }} min
																			</span>
																		</div>
																	</div>

																	<span class="text-success fw-bold fs-1">
																		DT{{ '%.2f'|format(service.price) }}
																	</span>
																</div>
															</div>
														{% else %}
															<div class="col-12 text-center text-muted">No services in this category yet.</div>
														{% endfor %}
													</div>
												</div>
											{% else %}
												<div class="text-center">No categories available.</div>
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
							<!-- end left panel -->

							<!-- begin sidebar (order cart) -->
							<div class="flex-row-auto w-xl-450px">
													<!--begin::Pos order-->
													<div class="card card-flush bg-body" id="kt_pos_form"> 
														<div class="card-header pt-5">
															<h3 class="card-title fw-bold text-gray-800 fs-2qx">Current Order</h3>
													<div class="symbol symbol-65px symbol-circle mb-5">
																<img src="{{ asset('assets/media/avatars/' ~ barber.image) }}" alt="image">
																<div class="bg-success position-absolute rounded-circle translate-middle start-100 top-100 border border-4 border-body h-15px w-15px ms-n3 mt-n3"></div>
															</div>
											
														<div class="card-body pt-0">
															<div class="table-responsive mb-8">
																<table class="table align-middle gs-0 gy-4 my-0">
																	<thead>
																		<tr>
																			<th class="min-w-175px"></th>
																			<th class="w-125px"></th>
																			<th class="w-60px"></th>
																		</tr>
																	</thead> 
																	<tbody>
															

															
																	</tbody> 
																</table> 
															</div> 
														<div class="d-flex flex-stack bg-success rounded-3 p-6 mb-11">
															<div class="fs-6 fw-bold text-white">
																<span class="d-block lh-1 mb-2">Subtotal</span>
																<span class="d-block mb-2">Discounts</span> 
																<span class="d-block fs-2qx lh-1">Total</span>
															</div>
															<div class="fs-6 fw-bold text-white text-end">
																<span id="kt_subtotal"   class="d-block lh-1 mb-2">DT 0.00</span>
																<span id="kt_discount"   class="d-block mb-2">DT 0.00</span>
																<span id="kt_total"      class="d-block fs-2qx lh-1">DT 0.00</span>
															</div>
														</div>

															<div class="m-0">
																<h1 class="fw-bold text-gray-800 mb-5">Payment Method</h1> 
																<div class="d-flex flex-equal gap-5 gap-xxl-9 px-0 mb-12" data-kt-buttons="true" data-kt-buttons-target="[data-kt-button]">
																	<label class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4 active" data-kt-button="true">
																		<input class="btn-check" type="radio" name="method" value="0" />
															
																		<i class="ki-duotone ki-dollar fs-2hx mb-2 pe-0">
																			<span class="path1"></span>
																			<span class="path2"></span>
																			<span class="path3"></span>
																		</i>
															
																		<span class="fs-7 fw-bold d-block">Cash</span>
																	</label>
															
																	<label class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4 " data-kt-button="true">
																		<input class="btn-check" type="radio" name="method" value="1" />
																
																		<i class="ki-duotone ki-credit-cart fs-2hx mb-2 pe-0">
																			<span class="path1"></span>
																			<span class="path2"></span>
																		</i>
																	
																		<span class="fs-7 fw-bold d-block">Card</span>
																	</label>
													
																</div>
                											<button id="btn-confirm" class="btn btn-primary fs-1 w-100 py-4">Confirmer Payment</button>															</div>
														</div>
													</div>
												</div>
						</div>
					</div>
				</div>
								</div> 
							</div> 
						</div>
				
					</body> 
			<script>
				let cartTotal = 0;                       

				function addServiceCardToCart(btn) {
					const name  = btn.dataset.serviceName;
					const price = parseFloat(btn.dataset.servicePrice);

					const row = `
					<tr data-kt-pos-element="item" data-price="DT {price}">
						<td class="pe-0">
							<div class="d-flex align-items-center">
								<img src="assets/media/stock/food/img-11.jpg" class="w-50px h-50px rounded-3 me-3" alt="${name}">
								<span class="fw-bold text-gray-800 fs-6 me-1">${name}</span>
							</div>
						</td>
						<td class="pe-0 text-center">
							<div class="position-relative d-flex align-items-center"
								data-kt-dialer="true"
								data-kt-dialer-min="0"
								data-kt-dialer-max="20"
								data-kt-dialer-step="1">
								<button type="button" class="btn btn-icon btn-sm btn-light btn-icon-gray-400" data-kt-dialer-control="decrease">
									<i class="ki-duotone ki-minus fs-3x"></i>
								</button>
								<input type="text" class="form-control border-0 text-center px-0 fs-3 fw-bold text-gray-800 w-30px" value="1" readonly>
								<button type="button" class="btn btn-icon btn-sm btn-light btn-icon-gray-400" data-kt-dialer-control="increase">
									<i class="ki-duotone ki-plus fs-3x"></i>
								</button>
							</div>
						</td>
						<td class="text-end">
							<span class="fw-bold text-primary fs-4">DT${price.toFixed(2)}</span>
						</td>
					</tr>`;

					document.querySelector('#kt_pos_form table tbody').insertAdjacentHTML('beforeend', row);
					cartTotal += price;

					/* totals without tax */
					document.getElementById('kt_subtotal').textContent = `DT${cartTotal.toFixed(2)}`; 
					document.getElementById('kt_total').textContent    = `DT${cartTotal.toFixed(2)}`;

					if (window.KTDialer) { KTDialer.createInstances(); }
				}
				</script>
			 <script>
document.getElementById('btn-confirm').addEventListener('click', async () => {
    const amountText = document.getElementById('kt_total').textContent.trim(); // DT45.50
    const amount = parseFloat(amountText.replace('DT', ''));
    const barberId = {{ barberId }};   // injected by controller

    const res = await fetch('{{ path('service_pay') }}', {
        method : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body   : JSON.stringify({ amount, barberId })
    });

    if (res.ok) {
        window.location.href = '{{ path('app_service', {id: barberId}) }}';
    } else {
        alert('Erreur lors de l’enregistrement du paiement');
    }
});
</script>
				</html>
				
 {% endblock %}